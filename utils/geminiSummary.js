import express, { Request, Response } from "express";
import { GoogleGenAI } from "@google/genai";
import dotenv from "dotenv";

// .env ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®
dotenv.config();

const router = express.Router();

// Gemini ‡¶ï‡ßç‡¶≤‡¶æ‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶®
const gemini = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY });


/**
 * ü§ñ ‡¶Æ‡¶ø‡¶ü‡¶ø‡¶Ç ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü ‡¶•‡ßá‡¶ï‡ßá Gemini API ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡•§
 * @param transcript - ‡¶Æ‡¶ø‡¶ü‡¶ø‡¶Ç‡¶Ø‡¶º‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü‡•§
 * @returns {Promise<string>} - ‡¶Æ‡¶ø‡¶ü‡¶ø‡¶Ç‡¶Ø‡¶º‡ßá‡¶∞ ‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™ ‡¶¨‡¶æ ‡¶è‡¶∞‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡•§
 */
async function generateSummary(transcript: string): Promise<string> {
    
    // ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶°‡ßá‡¶∂‡¶®
    if (!transcript || typeof transcript !== 'string' || transcript.trim().length === 0) {
        // ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡ßç‡¶™‡¶∑‡ßç‡¶ü ‡¶è‡¶∞‡¶∞ ‡¶•‡ßç‡¶∞‡ßã ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶Ø‡¶æ ‡¶∞‡¶æ‡¶â‡¶ü‡ßá ‡¶ß‡¶∞‡¶æ ‡¶™‡¶°‡¶º‡¶¨‡ßá‡•§
        throw new Error("Invalid or empty transcript provided.");
    }

    // ‡¶™‡ßç‡¶∞‡¶Æ‡ßç‡¶™‡¶ü ‡¶á‡¶û‡ßç‡¶ú‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø‡¶Ç
    const prompt = `Please act as a professional meeting minutes generator. Summarize the following meeting transcript, focusing explicitly on:
1. **Summary:** A brief overview of the discussion.
2. **Key Decisions:** Any final decisions or agreements made.
3. **Action Items:** A list of tasks assigned, including who is responsible (if available) and the next step.

TRANSCRIPT:\n\n${transcript}`;

    try {
        const result = await gemini.models.generateContent({
            model: "gemini-2.5-flash",
            contents: prompt
        });

        return result.text.trim() || "Summary could not be generated by the AI.";

    } catch (err) {
        // API ‡¶∏‡ßç‡¶§‡¶∞‡ßá‡¶∞ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶≤‡¶ó ‡¶ì ‡¶•‡ßç‡¶∞‡ßã ‡¶ï‡¶∞‡ßÅ‡¶®
        console.error("Gemini API Error:", (err as Error).message);
        throw new Error("Failed to communicate with the AI service.");
    }
}


/**
 * üîó ‡¶∞‡¶æ‡¶â‡¶ü: /api/ai-summary
 * ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü ‡¶ó‡ßç‡¶∞‡¶π‡¶£ ‡¶ï‡¶∞‡ßá ‡¶è‡¶¨‡¶Ç AI ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶∞‡¶ø ‡¶´‡ßá‡¶∞‡¶§ ‡¶™‡¶æ‡¶†‡¶æ‡¶Ø‡¶º‡•§
 */
router.post("/ai-summary", async (req: Request, res: Response) => {
    const { transcript } = req.body;
    
    // üö¶ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶°‡ßá‡¶∂‡¶® (‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü ‡¶¨‡¶°‡¶ø‡¶§‡ßá ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ)
    if (!transcript) {
        return res.status(400).json({ error: "Transcript is required in the request body." });
    }

    try {
        const summary = await generateSummary(transcript);
        
        // ‡¶∏‡¶´‡¶≤ ‡¶π‡¶≤‡ßá ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶∞‡¶ø ‡¶´‡ßá‡¶∞‡¶§ ‡¶¶‡¶ø‡¶®
        return res.json({ summary });

    } catch (error) {
        // generateSummary ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶Ü‡¶∏‡¶æ ‡¶è‡¶∞‡¶∞ ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®
        const errorMessage = (error as Error).message;
        
        if (errorMessage.includes("Invalid or empty transcript")) {
            return res.status(400).json({ error: errorMessage });
        }
        
        // ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞/API ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø
        console.error("Summary Route Error:", errorMessage);
        return res.status(500).json({ error: "Internal Server Error: Could not generate summary." });
    }
});

export default router;